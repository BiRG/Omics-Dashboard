{# The dashboard puts resources belonging to the user front and center#}
{% extends "base.html" %}
{% set protectedKeys =  ['owner', 'id', 'rowid', 'groupPermissions','allPermissions', 'userGroup', 'dateModified'] %}
{% block content %}
  <div class="container">
    <div class="page-header">
      <h1 class="display-4">{{ data['name'] }} ({{ type }} {{ data['id'] if 'id' in data else data['rowid'] }})</h1>
      {% if type.lower() == 'collection' %}
        <p>
          <a class="btn btn-primary" href="{{ url_for('download_collection', collection_id=data['id']) }}" role="button">
            <i class="fas fa-download"></i> HDF5
          </a>
        </p>
      </div>
      {% elif type.lower() == 'sample' %}
        <p class="lead">
          <a class="btn btn-primary btn-lg" href="{{ url_for('download_sample', sample_id=data['id']) }}" role="button">
            <i class="fas fa-download"></i> HDF5
          </a>
        </p>
      {% elif type.lower() == 'user' and session['user']['admin'] and not data['admin'] %}
        <p class="lead">
          <a class="btn btn-success btn-lg" id="elevateButton" href="" role="button">
            <i class="fas fa-arrow-up"></i> Elevate to Admin
          </a>
        </p>
      {% endif %}
  </div>

  <div class="card mb-3">
    <h4 class="card-header text-white bg-dark">Attributes</h4>
    <div class="card-body">
    {% if type.lower() != 'user' and is_write_permitted(get_user_id(), data) %}
      <h6 class="card-subtitle mb-2 text-muted">You have permission to edit this record.</h6>
    {% endif %}
      <table id="attributes" class="table table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
          <th>Key</th>
          <th>Value</th>
        {% if type.lower() != 'user' and is_write_permitted(get_user_id(), data) %}
          <th>Save Changes</th>
        {% endif %}
        </thead>
        <tbody>
        {% for key, value in data.items() %}
        <tr class="attribute-row">
          <td class="attribute-key">{{ key }}</td>
          {% if key in USERKEYS %}
          <td class="attribute-value"><a href="{{ url_for('render_user_profile', user_id=value) }}">{{ get_user_name(value) }}</a></td>
          {% elif key=='dateModified' %}
            <td class="attribute-value">{{ datetime.utcfromtimestamp(value).strftime('%Y-%m-%d %H:%M:%S (UTC)') }}</td>
          {% elif get_user_id() == data['owner'] and key in ['groupPermissions', 'allPermissions'] %}
            <td class="permission-select">
              <select class="form-control">
                <option value="full"{% if value == 'full' %} selected="selected"{% endif %}>Read/Write</option>
                <option value="readonly"{% if value == 'readonly' %} selected="selected"{% endif %}>Read Only</option>
                {% if key == 'allPermissions' %}
                  <option value="none"{% if value == 'none' %} selected="selected"{% endif %}>None</option>
                {% endif %}
              </select>
            </td>
          {% elif key == 'userGroup' and get_user_id() == data['owner'] %}
            <td class="user-group-select">
              {% include 'usergroupselector.html' %}
            </td>
          {% else %}
          <td class="attribute-value" contenteditable="{{ 'true' if key not in protectedKeys and is_write_permitted(get_user_id(), data) else 'false'}}">{{ value }}</td>
          {% endif %}
        {% if type.lower() != 'user' and is_write_permitted(get_user_id(), data) %}
          {% if key not in protectedKeys or get_user_id() == data['owner'] and key in ['groupPermissions', 'allPermissions', 'userGroup'] %}
            <td><button class="saveButton btn btn-sm btn-outline-primary"><p hidden>a</p><i class="fas fa-save"></i></button></td>
          {% else %}
            <td><p hidden>b</p></td><!-- We use a and b so that list is sortable by editability-->
          {% endif %}
        {% endif %}
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>


  <!-- Modal for failed update request-->
<div class="modal fade" id="failModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="failModalLabel">Update Failed</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true"><i class="fas fa-close"></i></span>
        </button>
      </div>
      <div class="modal-body" id="failModalBody">
        This will be changed when the modal is popped up!
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}
{# TODO: allow deletion of nonessential rows #}
{% block scripts %}
  {{ super() }}
  <script type="text/javascript">
  $(document).ready(function() {
    $('#attributes').DataTable();
  });

  $('#delete-form').submit(function() {
      console.log('Submit');
      if ($('#inputName').val() === '{{ data['name'] }}'){
          $.ajax({
              url: '{{ get_update_url(type, data) }}',
              type: 'DELETE',
              error: function(res){
                  $('#failModalBody').text(res.message);
                  $('#failModalLabel').text('Delete Failed');
                  $('#failModal').modal();
              },
              success: function(){
                  window.location.replace(document.domain + '{{ url_for('render_dashboard') }}');
              }
          });
      }
  });

  $('#elevateButton').click(function(){
      var url = '{{ url_for('edit_user', user_id=data['id']) }}';
      $.post(url, JSON.stringify({"admin": "1"}))
          .done(function(res){
              var message = 'Elevated user';
              $('#failModalLabel').text('Entry Updated');
              $('#failModalBody').text(message);
              $('#failModal').modal();
          })
          .fail(function(res){
              $('#failModalLabel').text('Update Failed');
              $('#failModalBody').text(res.responseJSON.message);
              $('#failModal').modal();
          });

  });

  $('.saveButton').click(function() {
      var url = '{{ get_update_url(type, data) }}';
      var reqData = {};
      var parentClass = $(this).parent().prev().attr('class');
      console.log('parentClass:');
      if (parentClass === 'permission-select' || parentClass === 'user-group-select'){
          reqData[$(this).parent().prev().prev().text()] = $(this).parent().prev().find('select').find(':selected').val();
      }
      else {
          reqData[$(this).parent().prev().prev().text()] = $(this).parent().prev().text();
      }
      console.log(reqData);
      $.post(url, JSON.stringify(reqData))
          .done(function(res) {
              var key = Object.keys(reqData);
              var message = 'Changed ' + key + ' to ' + reqData[key];
              $('#failModalLabel').text('Entry Updated');
              $('#failModalBody').text(message);
              $('#failModal').modal();
          })
          .fail(function(res){
              $('#failModalLabel').text('Update Failed');
              $('#failModalBody').text(res.responseJSON.message);
              $('#failModal').modal();
          });

  });
  </script>
{% endblock %}
